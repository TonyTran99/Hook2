import React, { useEffect, useMemo, useState } from "react";

/**
 * Hook Generator ‚Äì MISA Formula V1
 * Single-file React component using TailwindCSS.
 *
 * Features
 * - Two-panel layout: form (left) + live preview (right)
 * - 6 Emotions, 9 Hook Formats, 7 Story Structures (dropdowns)
 * - Fields: Subject, Action, Objective, Contrast, Proof (opt), Time (opt)
 * - Auto-generate Hook with formula + badges
 * - Copy to clipboard, Random Example, Add to History, Export CSV, Clear History
 * - LocalStorage persistence for history
 * - Responsive, modern UI, warm gold / green palette
 *
 * Usage
 * - Ensure TailwindCSS is available in your project
 * - Import and render <App /> as default export
 */

const EMOTIONS = [
  { key: "Awe", label: "Awe / Inspiration", emoji: "üåü" },
  { key: "Humor", label: "Humor / Amusement", emoji: "üòÑ" },
  { key: "Joy", label: "Joy / Excitement", emoji: "üéâ" },
  { key: "Outrage", label: "Anger / Outrage", emoji: "‚ö†Ô∏è" },
  { key: "Shock", label: "Shock / Curiosity", emoji: "üß†" },
  { key: "Empathy", label: "Sadness / Empathy", emoji: "üíó" },
];

const HOOK_FORMATS = [
  "Secret Reveal",
  "Case Study",
  "Comparison",
  "Question",
  "Education",
  "List",
  "Contrarian",
  "Personal Experience",
  "Problem",
];

const STORY_STRUCTURES = [
  "Breakdown",
  "Newscaster",
  "Case Study Explainer",
  "Listical",
  "Problem Solver",
  "Tutorial",
  "Personal Story",
];

const TONE_MAP = {
  Joy: "Vi·∫øt tone vui t∆∞∆°i, t√≠ch c·ª±c, kh√≠ch l·ªá.",
  Shock: "Ng·∫Øn g·ªçn, g√¢y t√≤ m√≤, m·ªü ƒë·∫ßu ngh·ªãch l√Ω.",
  Outrage: "Tone c·∫£nh b√°o, d√πng ƒë·ªông t·ª´ m·∫°nh, th√∫c gi·ª•c h√†nh ƒë·ªông.",
  Awe: "Truy·ªÅn c·∫£m h·ª©ng, nh·∫•n m·∫°nh s·ª± thay ƒë·ªïi l·ªõn v√† th√†nh t·ª±u.",
  Humor: "D√≠ d·ªèm, t·ª± nhi√™n, g·∫ßn g≈©i, th√™m chi ti·∫øt ƒë·ªùi th∆∞·ªùng.",
  Empathy: "M·ªÅm m·∫°i, ch·∫°m c·∫£m x√∫c, ƒë·ªÅ cao th·∫•u hi·ªÉu v√† s·∫ª chia.",
};

const EXAMPLES = {
  subjects: [
    "N√¥ng d√¢n Vi·ªát",
    "B·∫°n",
    "T√¥i",
    "Ch·ªß h·ªì t√¥m",
    "Doanh nghi·ªáp nh·ªè",
    "Ph·ª• huynh",
    "K·ªπ s∆∞ tr·∫ª",
  ],
  actions: [
    "kh√°m ph√°",
    "ph√°t hi·ªán",
    "th·ª≠",
    "·ª©ng d·ª•ng",
    "t·ªëi ∆∞u",
    "tr√°nh ƒë∆∞·ª£c",
    "nh·∫≠n ra",
  ],
  objectives: [
    "c√¥ng c·ª• t√≠nh gi√° b·∫°t HDPE",
    "c√°ch ti·∫øt ki·ªám 30% chi ph√≠ h·ªì",
    "gi·∫£i ph√°p ngƒÉn r√≤ r·ªâ",
    "ph∆∞∆°ng ph√°p t·ª± t√≠nh gi√° ch√≠nh x√°c",
    "c√°ch t·ªëi ∆∞u thi c√¥ng",
    "khung vi·∫øt hook hi·ªáu qu·∫£",
  ],
  contrasts: [
    "thay v√¨ g·ªçi h·ªèi t·ª´ng n∆°i",
    "kh√°c h·∫≥n nh·ªØng g√¨ b·∫°n nghƒ©",
    "t·ª´ r·ªëi r·∫Øm ƒë·∫øn r√µ r√†ng",
    "ch·ªâ trong v√†i b∆∞·ªõc ƒë∆°n gi·∫£n",
    "kh√¥ng c·∫ßn ch·ªù b√°o gi√°",
    "m√† √≠t ai ch·ªâ cho b·∫°n",
  ],
  proofs: [
    "ƒë√£ ki·ªÉm ch·ª©ng th·ª±c t·∫ø",
    "500 ng∆∞·ªùi ƒë√£ th·ª≠",
    "qua 100 d·ª± √°n",
    "t√¥i ƒë√£ l√†m ƒë∆∞·ª£c",
    "s·ªë li·ªáu minh ch·ª©ng r√µ r√†ng",
    "",
  ],
  times: [
    "trong 10 gi√¢y",
    "ngay h√¥m nay",
    "ch·ªâ sau 1 ph√∫t",
    "trong 7 ng√†y",
    "ch·ªâ 1 c√∫ nh·∫≠p",
    "",
  ],
};

function classNames(...xs) {
  return xs.filter(Boolean).join(" ");
}

function Badge({ children, color = "slate" }) {
  const colorMap = {
    gold: "bg-amber-100 text-amber-800 ring-amber-200",
    green: "bg-emerald-100 text-emerald-800 ring-emerald-200",
    slate: "bg-slate-100 text-slate-800 ring-slate-200",
    blue: "bg-sky-100 text-sky-800 ring-sky-200",
    rose: "bg-rose-100 text-rose-800 ring-rose-200",
    violet: "bg-violet-100 text-violet-800 ring-violet-200",
  }[color];
  return (
    <span className={classNames(
      "inline-flex items-center gap-1 rounded-2xl px-3 py-1 text-xs font-medium ring-1",
      colorMap
    )}>{children}</span>
  );
}

function useLocalStorage(key, initial) {
  const [state, setState] = useState(() => {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : initial;
    } catch {
      return initial;
    }
  });
  useEffect(() => {
    try { localStorage.setItem(key, JSON.stringify(state)); } catch {}
  }, [key, state]);
  return [state, setState];
}

function generateHook({ subject, action, objective, contrast, proof, time }) {
  const parts = [
    `üëâ ${subject?.trim() || "(Ch·ªß th·ªÉ)"}`,
    action?.trim() || "(h√†nh ƒë·ªông)",
    objective?.trim() || "(m·ª•c ti√™u)",
  ];
  let hook = parts.join(" ");
  const hasContrast = contrast && contrast.trim().length > 0;
  if (hasContrast) hook += ` ‚Äî ${contrast.trim()}`;
  const hasProof = proof && proof.trim().length > 0;
  if (hasProof) hook += ` (${proof.trim()})`;
  const hasTime = time && time.trim().length > 0;
  if (hasTime) hook += ` [${time.trim()}]`;
  hook += ".";
  return hook;
}

function PreviewCard({ hook, emotionKey, hookFormat, storyStructure }) {
  const emotion = EMOTIONS.find(e => e.key === emotionKey);
  return (
    <div className="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <div className="mb-3 text-sm font-semibold text-slate-500">Preview</div>
      <p className="text-lg leading-relaxed text-slate-900">{hook}</p>
      <div className="mt-4 flex flex-wrap items-center gap-2">
        <Badge color="gold">{emotion ? `${emotion.emoji} ${emotion.label}` : "üé≠ Emotion"}</Badge>
        <Badge color="green">üéØ {hookFormat || "Hook Format"}</Badge>
        <Badge color="blue">üìö {storyStructure || "Story Structure"}</Badge>
      </div>
      <div className="mt-4 rounded-xl bg-amber-50 p-4 text-sm text-amber-900">
        <span className="font-semibold">G·ª£i √Ω tone:</span> {emotionKey ? TONE_MAP[emotionKey] : "Ch·ªçn c·∫£m x√∫c ƒë·ªÉ g·ª£i √Ω tone vi·∫øt."}
      </div>
    </div>
  );
}

function Field({ label, children, hint }) {
  return (
    <label className="block">
      <div className="mb-1 text-sm font-medium text-slate-700">{label}</div>
      {children}
      {hint && <div className="mt-1 text-xs text-slate-500">{hint}</div>}
    </label>
  );
}

function TextInput(props) {
  return (
    <input
      {...props}
      className={classNames(
        "w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-slate-900 placeholder-slate-400",
        "focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-200"
      )}
    />
  );
}

function Select({ options, value, onChange, placeholder }) {
  return (
    <select
      value={value}
      onChange={e => onChange(e.target.value)}
      className={classNames(
        "w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-slate-900",
        "focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-200"
      )}
    >
      <option value="">{placeholder || "Ch·ªçn"}</option>
      {options.map((opt) => (
        <option key={opt.key || opt} value={opt.key || opt}>
          {opt.label || opt}
        </option>
      ))}
    </select>
  );
}

function ToolbarButton({ children, onClick, variant = "primary" }) {
  const styles =
    variant === "primary"
      ? "bg-emerald-600 text-white hover:bg-emerald-700"
      : variant === "ghost"
      ? "bg-transparent text-slate-700 hover:bg-slate-100"
      : variant === "danger"
      ? "bg-rose-600 text-white hover:bg-rose-700"
      : "bg-slate-800 text-white hover:bg-slate-900";
  return (
    <button
      onClick={onClick}
      className={classNames(
        "inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2 text-sm font-medium transition-colors",
        styles
      )}
    >
      {children}
    </button>
  );
}

function exportCSV(rows) {
  if (!rows?.length) return;
  const headers = [
    "Emotion",
    "Subject",
    "Action",
    "Objective",
    "Contrast",
    "Proof",
    "Time",
    "HookFormat",
    "StoryStructure",
    "Hook",
    "CreatedAt",
  ];
  const toCSV = (val) => {
    if (val == null) return "";
    const s = String(val).replaceAll('"', '""');
    return /[",\n]/.test(s) ? `"${s}"` : s;
  };
  const lines = [headers.join(",")];
  rows.forEach((r) => {
    lines.push(headers.map((h) => toCSV(r[h])).join(","));
  });
  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `hook_history_${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function randomPick(arr) {
  return arr[Math.floor(Math.random() * arr.length)] || "";
}

export default function App() {
  const [emotion, setEmotion] = useState("");
  const [hookFormat, setHookFormat] = useState("");
  const [storyStructure, setStoryStructure] = useState("");

  const [subject, setSubject] = useState("");
  const [action, setAction] = useState("");
  const [objective, setObjective] = useState("");
  const [contrast, setContrast] = useState("");
  const [proof, setProof] = useState("");
  const [time, setTime] = useState("");

  const [history, setHistory] = useLocalStorage("misa.hook.history", []);

  const hook = useMemo(
    () => generateHook({ subject, action, objective, contrast, proof, time }),
    [subject, action, objective, contrast, proof, time]
  );

  const copyHook = async () => {
    try {
      await navigator.clipboard.writeText(hook);
    } catch {}
  };

  const addToHistory = () => {
    const row = {
      Emotion: emotion,
      Subject: subject,
      Action: action,
      Objective: objective,
      Contrast: contrast,
      Proof: proof,
      Time: time,
      HookFormat: hookFormat,
      StoryStructure: storyStructure,
      Hook: hook,
      CreatedAt: new Date().toISOString(),
    };
    setHistory([row, ...history].slice(0, 500));
  };

  const randomExample = () => {
    setEmotion(randomPick(EMOTIONS).key);
    setHookFormat(randomPick(HOOK_FORMATS));
    setStoryStructure(randomPick(STORY_STRUCTURES));
    setSubject(randomPick(EXAMPLES.subjects));
    setAction(randomPick(EXAMPLES.actions));
    setObjective(randomPick(EXAMPLES.objectives));
    setContrast(randomPick(EXAMPLES.contrasts));
    setProof(randomPick(EXAMPLES.proofs));
    setTime(randomPick(EXAMPLES.times));
  };

  const clearForm = () => {
    setEmotion("");
    setHookFormat("");
    setStoryStructure("");
    setSubject("");
    setAction("");
    setObjective("");
    setContrast("");
    setProof("");
    setTime("");
  };

  const removeHistoryItem = (idx) => {
    setHistory(history.filter((_, i) => i !== idx));
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-amber-50 to-emerald-50">
      <header className="sticky top-0 z-10 border-b border-emerald-100 bg-white/80 backdrop-blur">
        <div className="mx-auto flex max-w-7xl items-center justify-between px-5 py-4">
          <div className="flex items-center gap-3">
            <div className="flex h-10 w-10 items-center justify-center rounded-2xl bg-emerald-600 text-white shadow-md">HG</div>
            <div>
              <h1 className="text-lg font-semibold text-slate-900">Hook Generator ‚Äì MISA Formula V1</h1>
              <p className="text-xs text-slate-500">Emotion ‚Üí 6 Power Words ‚Üí 9 Hook Formats ‚Üí 7 Story Structures</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <ToolbarButton onClick={randomExample} variant="ghost">üé≤ Random Example</ToolbarButton>
            <ToolbarButton onClick={copyHook}>üìã Copy Hook</ToolbarButton>
            <ToolbarButton onClick={addToHistory} variant="primary">‚ûï Add to History</ToolbarButton>
          </div>
        </div>
      </header>

      <main className="mx-auto grid max-w-7xl grid-cols-1 gap-6 px-5 py-6 md:grid-cols-2">
        {/* LEFT: FORM */}
        <section className="space-y-4">
          <div className="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <div className="mb-4 flex items-center justify-between">
              <h2 className="text-base font-semibold text-slate-900">Nh·∫≠p d·ªØ li·ªáu</h2>
              <div className="flex gap-2">
                <ToolbarButton onClick={clearForm} variant="ghost">üßπ Clear</ToolbarButton>
              </div>
            </div>

            <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
              <Field label="C·∫£m x√∫c ch·ªß ƒë·∫°o (Emotion)">
                <Select
                  options={EMOTIONS}
                  value={emotion}
                  onChange={setEmotion}
                  placeholder="Ch·ªçn c·∫£m x√∫c"
                />
              </Field>

              <Field label="ƒê·ªãnh d·∫°ng Hook (9 lo·∫°i)">
                <Select
                  options={HOOK_FORMATS}
                  value={hookFormat}
                  onChange={setHookFormat}
                  placeholder="Ch·ªçn ƒë·ªãnh d·∫°ng"
                />
              </Field>

              <Field label="C·∫•u tr√∫c k·ªÉ chuy·ªán (7 lo·∫°i)">
                <Select
                  options={STORY_STRUCTURES}
                  value={storyStructure}
                  onChange={setStoryStructure}
                  placeholder="Ch·ªçn c·∫•u tr√∫c"
                />
              </Field>

              <div></div>

              <Field label="Ch·ªß th·ªÉ (Subject)" hint="T√¥i / B·∫°n / N√¥ng d√¢n Vi·ªát / Doanh nghi·ªáp‚Ä¶">
                <TextInput value={subject} onChange={(e) => setSubject(e.target.value)} placeholder="V√≠ d·ª•: N√¥ng d√¢n Vi·ªát" />
              </Field>

              <Field label="H√†nh ƒë·ªông (Action)" hint="kh√°m ph√° / ph√°t hi·ªán / th·ª≠ / t·ªëi ∆∞u‚Ä¶">
                <TextInput value={action} onChange={(e) => setAction(e.target.value)} placeholder="V√≠ d·ª•: kh√°m ph√°" />
              </Field>

              <Field label="M·ª•c ti√™u / K·∫øt qu·∫£ (Objective)" hint="Gi√° tr·ªã h·ª©a h·∫πn ‚Äì k·∫øt qu·∫£ cu·ªëi c√πng">
                <TextInput value={objective} onChange={(e) => setObjective(e.target.value)} placeholder="V√≠ d·ª•: c√¥ng c·ª• t√≠nh gi√° b·∫°t HDPE" />
              </Field>

              <Field label="T∆∞∆°ng ph·∫£n (Contrast)" hint="t·ª´‚Ä¶ ƒë·∫øn‚Ä¶, kh√°c h·∫≥n‚Ä¶, kh√¥ng nh∆∞ b·∫°n nghƒ©‚Ä¶">
                <TextInput value={contrast} onChange={(e) => setContrast(e.target.value)} placeholder="V√≠ d·ª•: thay v√¨ g·ªçi h·ªèi t·ª´ng n∆°i" />
              </Field>

              <Field label="B·∫±ng ch·ª©ng (Proof ‚Äì t√πy ch·ªçn)" hint="ƒë√£ th·ª≠, s·ªë li·ªáu, case study‚Ä¶">
                <TextInput value={proof} onChange={(e) => setProof(e.target.value)} placeholder="V√≠ d·ª•: 500 ng∆∞·ªùi ƒë√£ th·ª≠" />
              </Field>

              <Field label="Th·ªùi gian (Time ‚Äì t√πy ch·ªçn)" hint="trong 10 gi√¢y / ngay h√¥m nay‚Ä¶">
                <TextInput value={time} onChange={(e) => setTime(e.target.value)} placeholder="V√≠ d·ª•: trong 10 gi√¢y" />
              </Field>
            </div>

            <div className="mt-5 flex flex-wrap items-center gap-2">
              <ToolbarButton onClick={copyHook}>üìã Copy</ToolbarButton>
              <ToolbarButton onClick={addToHistory}>‚ûï L∆∞u v√†o History</ToolbarButton>
              <ToolbarButton onClick={randomExample} variant="ghost">üé≤ Random</ToolbarButton>
            </div>
          </div>
        </section>

        {/* RIGHT: PREVIEW */}
        <section className="space-y-4">
          <PreviewCard
            hook={hook}
            emotionKey={emotion}
            hookFormat={hookFormat}
            storyStructure={storyStructure}
          />

          <div className="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <div className="mb-3 text-sm font-semibold text-slate-500">History ({history.length})</div>
            {history.length === 0 ? (
              <p className="text-sm text-slate-500">Ch∆∞a c√≥ hook n√†o. H√£y t·∫°o v√† l∆∞u l·∫°i ƒë·ªÉ xem l·ªãch s·ª≠.</p>
            ) : (
              <div className="space-y-3">
                {history.map((row, idx) => (
                  <div key={idx} className="rounded-xl border border-slate-100 p-4 hover:bg-slate-50">
                    <div className="mb-2 text-slate-900">{row.Hook}</div>
                    <div className="mb-3 flex flex-wrap items-center gap-2 text-xs">
                      {row.Emotion && <Badge color="gold">{row.Emotion}</Badge>}
                      {row.HookFormat && <Badge color="green">{row.HookFormat}</Badge>}
                      {row.StoryStructure && <Badge color="blue">{row.StoryStructure}</Badge>}
                      {row.Proof && <Badge color="violet">Proof</Badge>}
                      {row.Time && <Badge color="slate">Time</Badge>}
                      <span className="text-slate-400">{new Date(row.CreatedAt).toLocaleString()}</span>
                    </div>
                    <div className="flex gap-2">
                      <ToolbarButton onClick={() => navigator.clipboard.writeText(row.Hook)}>üìã Copy</ToolbarButton>
                      <ToolbarButton onClick={() => removeHistoryItem(idx)} variant="danger">üóëÔ∏è Delete</ToolbarButton>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {history.length > 0 && (
              <div className="mt-4 flex gap-2">
                <ToolbarButton onClick={() => exportCSV(history)} variant="ghost">‚¨áÔ∏è Export CSV</ToolbarButton>
                <ToolbarButton onClick={() => setHistory([])} variant="danger">üß® Clear All</ToolbarButton>
              </div>
            )}
          </div>
        </section>
      </main>

      <footer className="border-t border-emerald-100 bg-white/70">
        <div className="mx-auto max-w-7xl px-5 py-4 text-xs text-slate-500">
          ¬© {new Date().getFullYear()} MISA ‚Ä¢ Hook Generator ‚Äì MISA Formula V1 ‚Ä¢ Built with React + Tailwind
        </div>
      </footer>
    </div>
  );
}
